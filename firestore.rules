/**
 * This ruleset enforces a security model for the CineMagic movie catalog application.
 *
 * Core Philosophy:
 * The primary goal is to provide public, read-only access to a catalog of movies,
 * while allowing authenticated users to create, update, and delete their own entries.
 *
 * Data Structure:
 * The data is organized in a single top-level collection:
 * - /movies/{movieId}: Contains all individual movie documents. Each document
 *   now includes a `userId` field to denote ownership.
 *
 * Key Security Decisions:
 * - Public Read Access: The `/movies` collection is publicly readable to everyone
 *   to facilitate browsing the catalog.
 * - Authenticated Writes: Users must be authenticated to create, update, or delete movies.
 * - Owner-Only Write Access: Users can only modify or delete movies where their
 *   `request.auth.uid` matches the `userId` field in the movie document. This ensures
 *   users cannot tamper with entries they do not own.
 *
 * Denormalization for Authorization:
 * This ruleset uses a denormalization strategy by storing the `userId` directly on each
 * movie document. This allows for fast and inexpensive ownership checks without needing
 * extra database reads.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Manages the movie catalog. Allows public read access but restricts
     *              write operations to the authenticated owner of the document.
     * @path /movies/{movieId}
     * @allow (get, list) Anyone, including unauthenticated users, can read movie documents.
     * @allow (create) Any authenticated user can create a new movie, as long as they set themselves as the owner.
     * @allow (update, delete) Only the user whose UID matches the `userId` on the document can modify or delete it.
     */
    match /movies/{movieId} {
      allow read: if true;

      // Users must be authenticated to write data.
      allow create: if request.auth != null
                    // The incoming document's userId must match the creator's UID.
                    && request.resource.data.userId == request.auth.uid;
      
      allow update, delete: if request.auth != null
                            // The user's UID must match the userId on the existing document.
                            && resource.data.userId == request.auth.uid;
    }
  }
}
